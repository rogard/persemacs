#+title: init.org
#+author: Erwann Rogard 
#+property: header-args :tangle no

* source
** elisp
*** comment

#+name: el-license
#+begin_src emacs-lisp :results value raw
;; persemacs — Emacs configuration and functionality
;; Copyright (C) 2024—2025 — Erwann Rogard
;; Released under GPL 3.0
;; See https://www.gnu.org/licenses/gpl-3.0.en.html
#+end_src

*** defconst

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (defconst erw/init-parameter-list "Initialization parameters")
#+end_src

*** defmacro

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (defmacro erw/init-parameter-add (key value string)
    "Add a key-value-string to the `erw/init-parameter-list`."
    `(push (cons ,key (cons ,value ,string)) erw/init-parameter-list))
#+end_src

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (defun erw/init-parameter-value (key)
    "Retrieve the value associated with KEY from `erw/init-parameter-list`."
    (car (cdr (assoc key erw/init-parameter-list))))
#+end_src

*** parameter

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (erw/init-parameter-add  "init-vc-el" "../el/init.el" "Emacs initialization file (under version control")
#+end_src

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (erw/init-parameter-add  "init-startup" user-init-file "Emacs initialization file (loaded at startup)")
#+end_src

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (erw/init-parameter-add  "link-sh" "../sh/link.sh" "Ensures Emacs loads the initialization file")
#+end_src

#+header: :noweb-ref el-meta
#+begin_src emacs-lisp
  (erw/init-parameter-add
   "delegate-org"
   '((:file "../org/config.org" :lang "emacs-lisp"))
   "List of Org files to delegate to: each is a plist with `:file` (path relative to `init.el`) and `:lang` (the source block language).")
#+end_src

*** package
**** straight

#+header: :noweb-ref el-init
#+begin_src emacs-lisp
  ;; https://github.com/radian-software/straight.el?tab=readme-ov-file#getting-started
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+end_src

#+RESULTS:
: t

#+header: :noweb-ref el-init
#+begin_src emacs-lisp
  ;; Ensure Org is loaded early
  (straight-use-package 'org)
#+end_src

#+RESULTS:
: t

**** use-package

#+header: :noweb-ref el-init
#+begin_src emacs-lisp
  (straight-use-package 'use-package)
#+end_src

#+RESULTS:
: t

#+header: :noweb-ref el-init
#+begin_src emacs-lisp
  ;;  (unless (package-installed-p 'use-package)
  ;;    (package-refresh-contents)
  ;;    (package-install 'use-package))
  (eval-and-compile
    (setq use-package-always-ensure t))
  ;; (setq use-package-always-defer t))
#+end_src

#+RESULTS:
: t

*** delegate

TODO:
- meta-ify

#+header: :noweb-ref el-init
#+begin_src emacs-lisp
  (let ((dir-name (file-name-directory
  		 (or (file-truename load-file-name) buffer-file-name))))
    (dolist (pair meta-delegate-list) ;; beta
      (let ((source-file (plist-get pair :file))
  	  (source-lang (plist-get pair :lang)))
        (with-current-buffer (find-file-noselect (expand-file-name source-file dir-name))
  	(dolist (target-file (org-babel-tangle nil nil source-lang))
  	  (load-file target-file))))))
#+end_src

#+RESULTS:

** sh
*** shebang
:PROPERTIES:
:customize: true
:END:

#+header: :noweb-ref sh-shebang
#+name: sh-shebang
#+begin_src shell
  #!/usr/bin/env bash
#+end_src

*** startup
**** link

#+header: :noweb-ref sh-startup
#+begin_src sh
  if [[ -f "${meta_link}" ]]; then      
      cp "${meta_link}" "${meta_link}.bak" || {
          echo "Failed to create backup of ${meta_link}"; exit 1;
      }
  fi
#+end_src

**** vc_el

#+header: :noweb-ref sh-startup
#+begin_src sh
  if [[ ! -f "${meta_vc_el}" ]]; then
      echo "Init file ${meta_vc_el} not found"; exit 1;
  fi
#+end_src

**** do-link

#+header: :noweb-ref sh-startup
#+begin_src sh
  ln -sf "${meta_vc_el}" "${meta_link}" || {
      echo "Failed to create link"; exit 1;
  }
#+end_src

**** launch-kill

#+header: :noweb-ref sh-startup
#+begin_src sh
  emacs --batch --eval "(kill-emacs)" || {
      echo "Failed to launch Emacs with the new link"; exit 1;
  }
#+end_src

**** message 

#+header: :noweb-ref sh-startup
#+begin_src sh
  echo "Link created and Emacs verified successfully."
#+end_src

* execute
** elisp
*** meta
:properties:
:CUSTOM_ID: exec-el-meta
:end:

Do over this block:
- ~M-x ctrl-c-ctrl-c~
#+header: :noweb yes
#+begin_src emacs-lisp
  <<el-meta>>
  (let (result)
    (dolist (key '("init-vc-el" "init-startup" "link-sh")
      (push (expand-file-name (erw/init-parameter-value key))
            result))
     result)
#+end_src

#+RESULTS:
| /home/erwann/github/rogard/persemacs/sh/link.sh | /home/erwann/.emacs | /home/erwann/github/rogard/persemacs/el/init.el |

And for checking's sake:
- ~M-x ctrl-c-ctrl-c~
#+header: :noweb yes
#+begin_src emacs-lisp
(erw/init-parameter-value "delegate-org")
#+end_src

#+RESULTS:
| :file | ../org/config.org | :lang | emacs-lisp |

*** tangle
:PROPERTIES:
:header-args: :tangle (expand-file-name (erw/init-parameter-value "init-vc-el"))
:END:

Execute:
- ~org-narrow-to-subtree~
- ~C-u M-x org-babel-tangle~
- ~widen~

#+header: :noweb yes
#+begin_src emacs-lisp 
  <<el-license>>
#+end_src

#+header: :noweb yes
#+header: :var meta-delegate-list=(erw/init-parameter-value "delegate-org")
#+begin_src emacs-lisp 
  <<el-init>>
#+end_src

** sh
*** meta

Execute:
- This [[#exec-el-meta][headline]]'s steps
- ~M-x ctrl-c-ctrl-c~
#+begin_src emacs-lisp
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((shell . t)))
#+end_src

#+RESULTS:

*** tangle
:PROPERTIES:
:custom_id: exec-sh-tangle
:END:

Execute:
- ~M-x org-narrow-to-subtree~
- ~M-x org-babel-tangle~
- ~M-x widen~

#+header: :noweb yes
#+begin_src sh
  <<sh-shebang>>
#+end_src

#+header: :noweb yes
#+header: :tangle (expand-file-name (erw/init-parameter-value "link-sh"))
#+header: :var meta_vc_el=(expand-file-name (erw/init-parameter-value "init-vc-el"))
#+header: :var meta_link=(expand-file-name (erw/init-parameter-value "init-startup"))
#+begin_src sh
  <<sh-startup>>
#+end_src

*** other

#+header: :noweb yes
#+begin_src emacs-lisp
  (let (init-file (expand-file-name (symbol-value 'erw/init-tangle-file)))
    (load-file init-file))
#+end_src

#+RESULTS:
: t

#+begin_src sh
  chmod +x "${target}"
  source "${target}"
#+end_src

#+RESULTS:

* scratchpad

#+header: :noweb yes
#+begin_src emacs-lisp 
  <<el-meta>>
#+end_src

#+RESULTS:
: erw/init-link

#+begin_src emacs-lisp 
  (symbol-value 'erw/init-tangle-file)
#+end_src

#+RESULTS:
: ../el/init.el



#+header: :noweb yes
#+header: :noweb-ref el-tangle
#+begin_src emacs-lisp
<<el-macro>>
#+end_src

#+header: :noweb yes
#+header: :noweb-ref el-post
#+begin_src emacs-lisp
<<el-macro>>
#+end_src
